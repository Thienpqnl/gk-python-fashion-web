{% load static %}
<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>L·ªãch s·ª≠ ƒë∆°n h√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .star-rating {
      cursor: pointer;
      transition: color 0.2s;
    }

    .star-rating.active {
      color: #FBBF24;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="/" class="text-2xl font-bold text-red-600">Fashion Shop</a>
      <nav class="space-x-4">
        <a href="#" class="text-sm text-gray-600 hover:text-red-600">ƒê∆°n mua</a>
        <a href="#" class="text-sm text-gray-600 hover:text-red-600">T√†i kho·∫£n</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6 text-gray-800">L·ªãch s·ª≠ ƒë∆°n h√†ng</h1>

    <div id="orders-container" class="space-y-6">
    </div>
  </main>

  <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 animate-fade-in-down">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">ƒê√°nh gi√° s·∫£n ph·∫©m</h3>
        <button onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
      </div>

      <div class="flex items-center gap-3 mb-6 bg-gray-50 p-3 rounded border">
        <img id="modal-img" src="" alt="" class="w-12 h-12 object-cover rounded">
        <div>
          <p id="modal-title" class="font-semibold text-sm text-gray-800"></p>
          <p class="text-xs text-gray-500">Ph√¢n lo·∫°i: M·∫∑c ƒë·ªãnh</p>
        </div>
      </div>

      <form onsubmit="submitReview(event)">
        <input type="hidden" id="modal-product-id">
        <input type="hidden" id="modal-order-id">

        <div class="mb-5 text-center">
          <p class="text-sm text-gray-600 mb-2">Vui l√≤ng ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng</p>
          <div class="flex justify-center gap-3 text-3xl text-gray-300">
            <span class="star-rating" onclick="setRating(1)">‚òÖ</span>
            <span class="star-rating" onclick="setRating(2)">‚òÖ</span>
            <span class="star-rating" onclick="setRating(3)">‚òÖ</span>
            <span class="star-rating" onclick="setRating(4)">‚òÖ</span>
            <span class="star-rating" onclick="setRating(5)">‚òÖ</span>
          </div>
          <input type="hidden" id="ratingValue" required>
        </div>

        <div class="mb-6">
          <textarea id="reviewComment" rows="3"
            class="w-full p-3 border border-gray-300 rounded focus:ring-1 focus:ring-red-500 focus:outline-none text-sm"
            placeholder="Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m..."></textarea>
        </div>

        <div class="flex gap-3">
          <button type="button" onclick="closeReviewModal()"
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 text-sm font-medium">Tr·ªü
            l·∫°i</button>
          <button type="submit"
            class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-medium">Ho√†n
            th√†nh</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // 1. C·∫§U H√åNH URL API (D·ª±a tr√™n c·∫•u tr√∫c history/urls.py b·∫°n ƒë√£ t·∫°o)
    const API_LIST = '/api/history/list/';
    const API_DETAIL = '/api/history/detail/';
    const API_SUBMIT_REVIEW = '/api/reviews/submit/';

    // 2. H√ÄM T·∫¢I V√Ä RENDER D·ªÆ LI·ªÜU T·ª™ SERVER
    async function loadOrders() {
      const container = document.getElementById('orders-container');

      // Hi·ªÉn th·ªã loading trong l√∫c ƒë·ª£i
      container.innerHTML = `
            <div class="text-center py-10">
                <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>`;

      try {
        // B∆∞·ªõc A: L·∫•y danh s√°ch ƒë∆°n h√†ng (ID, Status, Total)
        const resList = await fetch(API_LIST);
        const dataList = await resList.json();

        if (dataList.status !== 'success') {
          container.innerHTML = `<p class="text-center text-red-500">L·ªói t·∫£i d·ªØ li·ªáu.</p>`;
          return;
        }

        const orders = dataList.data;

        if (orders.length === 0) {
          container.innerHTML = `
                    <div class="text-center py-10 bg-white rounded border">
                        <p class="text-gray-500">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
                        <a href="/" class="text-red-600 font-bold hover:underline mt-2 inline-block">Mua s·∫Øm ngay</a>
                    </div>`;
          return;
        }

        let html = '';

        // B∆∞·ªõc B: Duy·ªát t·ª´ng ƒë∆°n ƒë·ªÉ l·∫•y chi ti·∫øt s·∫£n ph·∫©m
        // (L∆∞u √Ω: D√πng for...of ƒë·ªÉ d√πng ƒë∆∞·ª£c await b√™n trong)
        for (const basicOrder of orders) {

          // G·ªçi API Detail ƒë·ªÉ l·∫•y items
          const resDetail = await fetch(`${API_DETAIL}${basicOrder.id}/`);
          const dataDetail = await resDetail.json();

          // N·∫øu l·ªói th√¨ d√πng t·∫°m data c∆° b·∫£n, n·∫øu ok th√¨ d√πng data chi ti·∫øt
          const order = (dataDetail.status === 'success') ? dataDetail.data : basicOrder;
          const items = order.items || []; // ƒê·∫£m b·∫£o items lu√¥n l√† m·∫£ng

          // --- LOGIC GIAO DI·ªÜN (Gi·ªØ nguy√™n style c·ªßa b·∫°n) ---

          // 1. X·ª≠ l√Ω Badge Tr·∫°ng th√°i
          let statusBadge = '';
          // Mapping tr·∫°ng th√°i t·ª´ Backend sang ti·∫øng Vi·ªát & M√†u s·∫Øc
          switch (order.status) {
            case 'delivered': // ƒê√£ giao
              statusBadge = '<span class="text-green-600 font-medium flex items-center gap-1">‚úî Ho√†n th√†nh</span>';
              break;
            case 'cancelled': // ƒê√£ h·ªßy
              statusBadge = '<span class="text-red-500 font-medium flex items-center gap-1">‚úñ ƒê√£ h·ªßy</span>';
              break;
            case 'shipped': // ƒêang giao
              statusBadge = '<span class="text-orange-500 font-medium flex items-center gap-1">üöö ƒêang v·∫≠n chuy·ªÉn</span>';
              break;
            default: // Pending, Processing
              statusBadge = '<span class="text-blue-500 font-medium flex items-center gap-1">‚è≥ ƒêang x·ª≠ l√Ω</span>';
          }

          // 2. Render danh s√°ch s·∫£n ph·∫©m (Items)
          let itemsHtml = items.map(item => {
            // Logic n√∫t ƒë√°nh gi√°: Ch·ªâ hi·ªán khi 'delivered'
            let actionBtn = '';

            if (order.status === 'delivered') {
              if (item.is_reviewed) {
                // ƒê√£ ƒë√°nh gi√° -> Hi·ªán n√∫t x√°m
                actionBtn = `<button disabled class="px-4 py-2 border border-gray-200 bg-gray-50 text-gray-400 rounded text-sm cursor-not-allowed">ƒê√£ ƒë√°nh gi√°</button>`;
              } else {
                // Ch∆∞a ƒë√°nh gi√° -> Hi·ªán n√∫t ƒë·ªè, truy·ªÅn th√™m product_id
                actionBtn = `<button onclick="openReviewModal('${order.id}', '${item.product_id}', '${item.product_title}', '${item.image}')" class="px-6 py-2 border border-red-500 text-red-500 rounded text-sm hover:bg-red-50 transition">ƒê√°nh gi√°</button>`;
              }
            }

            // Map field t·ª´ API v√†o HTML (ch√∫ √Ω t√™n bi·∫øn item.product_title, item.price...)
            return `
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-4 py-4 border-b border-gray-100 last:border-0">
                        <div class="flex items-start gap-3 flex-1">
                            <img src="${item.image || 'https://via.placeholder.com/150'}" class="w-20 h-20 object-cover rounded border bg-gray-50">
                            <div>
                                <h4 class="font-medium text-gray-800 line-clamp-2">${item.product_title}</h4>
                                <p class="text-gray-500 text-sm mt-1">S·ªë l∆∞·ª£ng: ${item.quantity}</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-row md:flex-col items-center md:items-end gap-4 w-full md:w-auto justify-between md:justify-end mt-2 md:mt-0">
                            <span class="text-red-600 font-medium">‚Ç´${(item.price * item.quantity).toLocaleString('vi-VN')}</span>
                            ${actionBtn}
                        </div>
                    </div>
                    `;
          }).join('');

          // 3. N√∫t h·ªßy ƒë∆°n (Ch·ªâ hi·ªán khi pending)
          let cancelBtnHtml = '';
          if (order.status === 'pending') {
            cancelBtnHtml = `
                        <button onclick="cancelOrder(${order.id})" class="text-xs text-red-500 hover:underline mr-4 border border-red-200 px-2 py-1 rounded">
                            H·ªßy ƒë∆°n h√†ng
                        </button>
                    `;
          }

          // 4. C·ªông d·ªìn HTML khung ƒë∆°n h√†ng
          html += `
                <div class="bg-white rounded-md shadow-sm border border-gray-200 overflow-hidden">
                    <div class="flex justify-between items-center bg-gray-50 px-4 py-3 border-b border-gray-200">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-800 text-sm">#${order.id}</span>
                            <span class="text-gray-400 text-xs">|</span>
                            <span class="text-gray-500 text-xs">${order.created_at}</span>
                        </div>
                        <div class="flex items-center">
                            ${cancelBtnHtml}
                            <div class="text-sm uppercase font-bold tracking-wide">
                                ${statusBadge}
                            </div>
                        </div>
                    </div>

                    <div class="px-4">
                        ${itemsHtml}
                    </div>

                    <div class="px-4 py-4 bg-red-50/10 border-t border-gray-100 text-right">
                        <span class="text-gray-600 text-sm mr-2">T·ªïng s·ªë ti·ªÅn:</span>
                        <span class="text-xl font-bold text-red-600">‚Ç´${order.total_money.toLocaleString('vi-VN')}</span>
                    </div>
                </div>
                `;
        }

        container.innerHTML = html;

      } catch (err) {
        console.error(err);
        container.innerHTML = `<p class="text-center text-red-500">L·ªói k·∫øt n·ªëi Server. Vui l√≤ng th·ª≠ l·∫°i sau.</p>`;
      }
    }

    // 3. H√ÄM H·ª¶Y ƒê∆†N H√ÄNG (G·ªçi API)
    async function cancelOrder(orderId) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n n√†y kh√¥ng?")) return;

      try {
        const response = await fetch(`/history/api/cancel/${orderId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}' // C·∫ßn token ƒë·ªÉ Django ch·∫•p nh·∫≠n POST
          }
        });
        const data = await response.json();

        if (data.status === 'success') {
          alert("ƒê√£ h·ªßy ƒë∆°n h√†ng!");
          loadOrders(); // T·∫£i l·∫°i danh s√°ch
        } else {
          alert("L·ªói: " + data.message);
        }
      } catch (err) {
        alert("L·ªói k·∫øt n·ªëi!");
      }
    }

    // 4. LOGIC MODAL & REVIEW (Gi·ªØ nguy√™n nh∆∞ c≈©)
function openReviewModal(orderId, prodId, title, image) { // Th√™m tham s·ªë prodId
    document.getElementById('modal-order-id').value = orderId;
    
    // T·∫°o ho·∫∑c c·∫≠p nh·∫≠t input hidden cho product_id
    let prodInput = document.getElementById('modal-product-id');
    if(!prodInput) {
        prodInput = document.createElement('input');
        prodInput.type = 'hidden';
        prodInput.id = 'modal-product-id';
        document.querySelector('form').appendChild(prodInput);
    }
    prodInput.value = prodId; // L∆∞u ID s·∫£n ph·∫©m

    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-img').src = image;
    
    document.getElementById('reviewComment').value = '';
    setRating(0);
    
    document.getElementById('reviewModal').classList.remove('hidden');
    document.getElementById('reviewModal').classList.add('flex');
}

    function closeReviewModal() {
      document.getElementById('reviewModal').classList.add('hidden');
      document.getElementById('reviewModal').classList.remove('flex');
    }

    function setRating(val) {
      document.getElementById('ratingValue').value = val;
      const stars = document.querySelectorAll('.star-rating');
      stars.forEach((star, index) => {
        if (index < val) {
          star.classList.add('active');
          star.classList.remove('text-gray-300');
        } else {
          star.classList.remove('active');
          star.classList.add('text-gray-300');
        }
      });
    }


async function submitReview(e) {
    e.preventDefault();
    const orderId = document.getElementById('modal-order-id').value;
    const productId = document.getElementById('modal-product-id').value;
    const rating = document.getElementById('ratingValue').value;
    const comment = document.getElementById('reviewComment').value;
    
    if(!rating || rating == '0') {
        alert("Vui l√≤ng ch·ªçn s·ªë sao!");
        return;
    }

    try {
        const response = await fetch(API_SUBMIT_REVIEW, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Django CSRF Token
            },
            body: JSON.stringify({
                order_id: orderId,
                product_id: productId,
                rating: rating,
                comment: comment
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            alert("ƒê√°nh gi√° th√†nh c√¥ng! C·∫£m ∆°n b·∫°n.");
            closeReviewModal();
            loadOrders(); // T·∫£i l·∫°i danh s√°ch ƒë∆°n h√†ng ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
        } else {
            alert("L·ªói: " + data.message);
        }
    } catch (err) {
        console.error(err);
        alert("L·ªói k·∫øt n·ªëi Server");
    }
}


    
    // KH·ªûI CH·∫†Y
    document.addEventListener('DOMContentLoaded', loadOrders);
  </script>



</body>

</html>